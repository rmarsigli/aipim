#!/usr/bin/env node
"use strict";var z=Object.create;var I=Object.defineProperty;var H=Object.getOwnPropertyDescriptor;var K=Object.getOwnPropertyNames;var W=Object.getPrototypeOf,q=Object.prototype.hasOwnProperty;var Y=(e,t,o,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of K(t))!q.call(e,i)&&i!==o&&I(e,i,{get:()=>t[i],enumerable:!(n=H(t,i))||n.enumerable});return e};var r=(e,t,o)=>(o=e!=null?z(W(e)):{},Y(t||!e||!e.__esModule?I(o,"default",{value:e,enumerable:!0}):o,e));var N=require("commander"),m=r(require("chalk"));var G=r(require("ora")),s=r(require("chalk"));var d=r(require("fs-extra")),h=r(require("path"));var A=r(require("fs-extra")),p=(e,t)=>e?.dependencies?.[t]||e?.devDependencies?.[t],P=e=>A.default.pathExistsSync(e),F=[{id:"astro",name:"Astro",template:"astro",check:e=>p(e,"astro")||P("astro.config.mjs")||P("astro.config.js")},{id:"nextjs",name:"Next.js",template:"nextjs",check:e=>p(e,"next")||P("next.config.js")},{id:"react-vite",name:"React (Vite)",template:"react",check:e=>p(e,"react")&&P("vite.config.js")},{id:"react-cra",name:"React (CRA)",template:"react",check:e=>p(e,"react")&&p(e,"react-scripts")},{id:"react",name:"React",template:"react",check:e=>p(e,"react")},{id:"vue",name:"Vue",template:"vue",check:e=>p(e,"vue")},{id:"svelte",name:"Svelte",template:"svelte",check:e=>p(e,"svelte")}],S={"pnpm-lock.yaml":"pnpm","yarn.lock":"yarn","package-lock.json":"npm","bun.lockb":"bun"},D=["CLAUDE.md","GEMINI.md","CHATGPT.md"];async function R(e=process.cwd()){let t=h.default.join(e,"package.json"),o=await d.default.pathExists(t)?await d.default.readJson(t):null,[n,i,a,g]=await Promise.all([d.default.pathExists(h.default.join(e,".git")),d.default.pathExists(h.default.join(e,"node_modules")),d.default.pathExists(h.default.join(e,".project")),Q(e,D)]),{framework:u,frameworkVersion:k}=B(o);return{framework:u,frameworkVersion:k,packageManager:await J(e),hasGit:n,hasNodeModules:i,existingSetup:{hasProject:a,hasPrompts:g}}}function B(e){if(!e)return{framework:null,frameworkVersion:null};let t=F.find(n=>n.check(e));if(!t)return{framework:null,frameworkVersion:null};let o=M(e,t.id)||M(e,t.id.split("-")[0]);return{framework:t.id,frameworkVersion:o}}async function J(e){for(let[t,o]of Object.entries(S))if(await d.default.pathExists(h.default.join(e,t)))return o;return null}var M=(e,t)=>e?.dependencies?.[t]||e?.devDependencies?.[t];async function Q(e,t){let o=[];for(let n of t)await d.default.pathExists(h.default.join(e,n))&&o.push(n);return o}var c=r(require("fs-extra")),l=r(require("path"));var E=r(require("fs-extra")),$=r(require("path"));async function O(e,t,o){let n=[];for(let g of t){let u=$.default.join(o,`guidelines/${g}.md`);if(await E.default.pathExists(u)){let k=await E.default.readFile(u,"utf-8");n.push(k)}}if(n.length===0)return e;let i=n.join(`

---

`);return e.replace(/{{SLOT:guidelines}}[\s\S]*?{{\/SLOT:guidelines}}/,`{{SLOT:guidelines}}

${i}

{{/SLOT:guidelines}}`)}async function T(e,t){let o=l.default.join(__dirname,"templates");if(c.default.existsSync(o)||(o=l.default.join(__dirname,"../templates")),c.default.existsSync(o)||(o=l.default.join(process.cwd(),"src/templates")),!c.default.existsSync(o))throw new Error(`Templates directory not found. Searched in: ${l.default.join(__dirname,"templates")} and ${l.default.join(__dirname,"../templates")}`);await X(o);for(let n of e.ais)await Z(n,e,o);await te()}async function X(e){let t=l.default.join(e,"base/.project"),o=".project";try{await c.default.copy(t,o,{overwrite:!1,errorOnExist:!1})}catch(i){let a=i;throw a.code==="EACCES"?new Error(`Permission denied: Cannot write to ${o}`):a.code==="ENOSPC"?new Error("Disk full: Not enough space to install"):i}let n=["backlog","completed","decisions","docs","ideas","reports"];for(let i of n)await c.default.ensureDir(l.default.join(o,i))}async function Z(e,t,o){let n=l.default.join(o,"base/project-manager.md"),i=await c.default.readFile(n,"utf-8");t.guidelines&&t.guidelines.length>0&&(i=await O(i,t.guidelines,o));let a=ee(e);await c.default.writeFile(a,i,"utf-8")}function ee(e){return{"claude-code":"CLAUDE.md","claude-ai":"CLAUDE.md",gemini:"GEMINI.md",chatgpt:"CHATGPT.md"}[e]||`${e.toUpperCase()}.md`}async function te(){let e=[".project/scripts/pre-session.sh",".project/scripts/validate-dod.sh"];for(let t of e)await c.default.pathExists(t)&&await c.default.chmod(t,"755")}var j=r(require("inquirer")),y=r(require("chalk"));async function b(e,t={}){console.log(y.default.blue(`
\u{1F4CB} Installation Options
`));let{ais:o}=await j.default.prompt([{type:"checkbox",name:"ais",message:"Which AI tools will you use?",choices:[{name:"Claude Code (terminal AI assistant)",value:"claude-code",checked:!0},{name:"Claude.ai (web interface)",value:"claude-ai",checked:!0},{name:"Google Gemini",value:"gemini",checked:!1},{name:"ChatGPT",value:"chatgpt",checked:!1}],validate:g=>g.length<1?"You must choose at least one AI tool.":!0}]),n=[{name:"React",value:"react",checked:e.framework?.includes("react")},{name:"Astro",value:"astro",checked:e.framework==="astro"},{name:"Next.js",value:"nextjs",checked:e.framework==="nextjs"},{name:"Vue",value:"vue",checked:e.framework==="vue"}],{guidelines:i}=await j.default.prompt([{type:"checkbox",name:"guidelines",message:"Add framework-specific guidelines?",choices:n}]),{version:a}=await j.default.prompt([{type:"list",name:"version",message:"Choose system version:",choices:[{name:"Compact (1,000 tokens, optimized) [RECOMMENDED]",value:"compact",short:"Compact"},{name:"Full (4,000 tokens, comprehensive)",value:"full",short:"Full"}],default:"compact"}]);if(!t.yes){console.log(y.default.blue(`
\u{1F4C4} Installation Summary
`)),console.log("Files to be created:"),console.log(y.default.gray("  \u2022 .project/ (directory structure)"));let g=a==="compact"?"~1,000":"~4,000";o.forEach(C=>{let V=oe(C);console.log(y.default.gray(`  \u2022 ${V} (${g} tokens${i.length>0?" + guidelines":""})`))});let u=e.existingSetup.hasPrompts;u.length>0&&(console.log(y.default.yellow(`
\u26A0\uFE0F  Warning: This will replace existing files:`)),u.forEach(C=>console.log(y.default.yellow(`   \u2022 ${C}`))));let{confirm:k}=await j.default.prompt([{type:"confirm",name:"confirm",message:"Proceed with installation?",default:!0}]);if(!k)return null}return{ais:o,guidelines:i,version:a,skipConfirmation:t.yes||!1}}function oe(e){return{"claude-code":"CLAUDE.md","claude-ai":"CLAUDE.md",gemini:"GEMINI.md",chatgpt:"CHATGPT.md"}[e]||`${e.toUpperCase()}.md`}async function L(e={}){try{let t=(0,G.default)("Detecting project...").start(),o=await R();t.succeed("Project detected"),o.framework&&console.log(s.default.gray(`   \u2705 Found: ${o.framework} project`)),o.hasGit&&console.log(s.default.gray("   \u2705 Git repository: Yes")),o.packageManager&&console.log(s.default.gray(`   \u2705 Package manager: ${o.packageManager}`));let n;if(e.preset?(console.log(s.default.yellow(`
  Preset feature coming soon, using interactive mode
`)),n=await b(o,e)):e.ai&&e.guidelines?n={ais:Array.isArray(e.ai)?e.ai:[e.ai],guidelines:Array.isArray(e.guidelines)?e.guidelines:[e.guidelines],version:e.full?"full":"compact",skipConfirmation:e.yes||!1}:n=await b(o,e),!n){console.log(s.default.red(`
\u274C Installation cancelled
`));return}t.start("Installing..."),await T(n,o),t.succeed("Installation complete!"),console.log(s.default.green(`
\u{1F389} Installation complete!
`)),console.log("Next steps:"),console.log(s.default.gray("  1. Run: .project/scripts/pre-session.sh")),console.log(s.default.gray("  2. Create first task: cp .project/_templates/v1/task-template.md .project/current-task.md")),console.log(s.default.gray(`  3. Start coding with AI!
`)),(n.ais.includes("claude-code")||n.ais.includes("claude-ai"))&&(console.log(s.default.blue("\u{1F4DA} Start your AI session with:")),console.log(s.default.blue(`   "Follow session start protocol and continue development"
`)))}catch(t){throw t}}var v=r(require("chalk"));async function _(e={}){console.log(v.default.yellow(`
\u26A0\uFE0F  Update command coming in v1.1!
`)),console.log("For now, to update:"),console.log(v.default.gray("  1. Backup your customizations")),console.log(v.default.gray("  2. Run: npx ia-project-manager install --yes")),console.log(v.default.gray(`  3. Restore your customizations
`))}var x="1.0.0";var w=new N.Command,U=`
 \u2588\u2588\u2588\u2588\u2588\u2557 \u2588\u2588\u2557\u2588\u2588\u2588\u2588\u2588\u2588\u2557 \u2588\u2588\u2588\u2557   \u2588\u2588\u2588\u2557
\u2588\u2588\u2554\u2550\u2550\u2588\u2588\u2557\u2588\u2588\u2551\u2588\u2588\u2554\u2550\u2550\u2588\u2588\u2557\u2588\u2588\u2588\u2588\u2557 \u2588\u2588\u2588\u2588\u2551
\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2551\u2588\u2588\u2551\u2588\u2588\u2588\u2588\u2588\u2588\u2554\u255D\u2588\u2588\u2554\u2588\u2588\u2588\u2588\u2554\u2588\u2588\u2551
\u2588\u2588\u2554\u2550\u2550\u2588\u2588\u2551\u2588\u2588\u2551\u2588\u2588\u2554\u2550\u2550\u2550\u255D \u2588\u2588\u2551\u255A\u2588\u2588\u2554\u255D\u2588\u2588\u2551
\u2588\u2588\u2551  \u2588\u2588\u2551\u2588\u2588\u2551\u2588\u2588\u2551     \u2588\u2588\u2551 \u255A\u2550\u255D \u2588\u2588\u2551
\u255A\u2550\u255D  \u255A\u2550\u255D\u255A\u2550\u255D\u255A\u2550\u255D     \u255A\u2550\u255D     \u255A\u2550\u255D
`;w.name("aipm").description("AI-optimized project management system").version(x);w.command("install").description("Install AIPM in current directory").option("-y, --yes","Skip confirmation prompts").option("-p, --preset <name>","Use preset configuration").option("--ai <ais...>","AI tools to use (claude-code, gemini, chatgpt)").option("--guidelines <frameworks...>","Framework guidelines (react, astro)").option("--compact","Use compact version (default)",!0).option("--full","Use full version").action(async e=>{console.log(m.default.blue(U)),console.log(m.default.blue(`AIPM v${x}
`));try{await L(e)}catch(t){console.error(m.default.red(`
\u274C Error: ${t.message}
`)),process.exit(1)}});w.command("update").description("Update existing installation").option("-f, --force","Overwrite customizations").action(async e=>{console.log(m.default.blue(U)),console.log(m.default.blue(`AIPM v${x}
`));try{await _(e)}catch(t){console.error(m.default.red(`
\u274C Error: ${t.message}
`)),process.exit(1)}});w.command("diff").description("Show what would change with update").action(async()=>{console.log(m.default.yellow(`
\u{1F50D} Diff command coming soon!
`))});w.command("validate").description("Validate current installation").action(async()=>{console.log(m.default.yellow(`
\u{1F50D} Validate command coming soon!
`))});w.parse(process.argv);process.argv.slice(2).length||w.outputHelp();
