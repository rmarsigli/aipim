#!/usr/bin/env node
import{Command as ue}from"commander";import y from"chalk";import le from"ora";import V from"chalk";import P from"fs-extra";import C from"path";import Q from"fs-extra";var p={PACKAGE_JSON:"package.json",PROJECT_DIR:".project",GIT_DIR:".git",NODE_MODULES:"node_modules",PRE_SESSION_SCRIPT:".project/scripts/pre-session.sh",TASK_TEMPLATE:".project/_templates/v1/task-template.md",CURRENT_TASK:".project/current-task.md"},f={CLAUDE:"CLAUDE.md",GEMINI:"GEMINI.md",CHATGPT:"CHATGPT.md"},S=["backlog","completed","decisions","docs","ideas","reports","scripts","_templates"],g={CLAUDE_CODE:"claude-code",CLAUDE_AI:"claude-ai",GEMINI:"gemini",CHATGPT:"chatgpt"};var w=(e,t)=>!!(e?.dependencies?.[t]||e?.devDependencies?.[t]),v=e=>Q.pathExistsSync(e),_=[{id:"astro",name:"Astro",template:"astro",check:e=>w(e,"astro")||v("astro.config.mjs")||v("astro.config.js")},{id:"nextjs",name:"Next.js",template:"nextjs",check:e=>w(e,"next")||v("next.config.js")},{id:"react-vite",name:"React (Vite)",template:"react",check:e=>w(e,"react")&&v("vite.config.js")},{id:"react-cra",name:"React (CRA)",template:"react",check:e=>w(e,"react")&&w(e,"react-scripts")},{id:"react",name:"React",template:"react",check:e=>w(e,"react")},{id:"vue",name:"Vue",template:"vue",check:e=>w(e,"vue")},{id:"svelte",name:"Svelte",template:"svelte",check:e=>w(e,"svelte")}],$={"pnpm-lock.yaml":"pnpm","yarn.lock":"yarn","package-lock.json":"npm","bun.lockb":"bun"},M=[f.CLAUDE,f.GEMINI,f.CHATGPT];import k from"chalk";var D=class{isVerbose=!1;setVerbose(t){this.isVerbose=t}info(t){console.log(k.blue("\u2139"),t)}success(t){console.log(k.green("\u2714"),t)}warn(t){console.warn(k.yellow("\u26A0"),t)}error(t){let i=t instanceof Error?t.message:t;console.error(k.red("\u2716"),i)}debug(t,i){this.isVerbose&&(console.log(k.gray("\u{1F41B}"),t),i&&console.log(k.gray(JSON.stringify(i,null,2))))}},o=new D;async function L(e=process.cwd()){o.debug(`Detecting project in: ${e}`);let t=C.join(e,p.PACKAGE_JSON),i=await P.pathExists(t)?await P.readJson(t):null,[r,n,s,a]=await Promise.all([P.pathExists(C.join(e,p.GIT_DIR)),P.pathExists(C.join(e,p.NODE_MODULES)),P.pathExists(C.join(e,p.PROJECT_DIR)),ee(e,M)]),{framework:m,frameworkVersion:E}=X(i);return{framework:m,frameworkVersion:E,packageManager:await Z(e),hasGit:r,hasNodeModules:n,existingSetup:{hasProject:s,hasPrompts:a}}}function X(e){if(!e)return{framework:null,frameworkVersion:null};let t=_.find(r=>r.check(e));if(!t)return{framework:null,frameworkVersion:null};let i=U(e,t.id)||U(e,t.id.split("-")[0]);return{framework:t.id,frameworkVersion:i}}async function Z(e){for(let[t,i]of Object.entries($))if(await P.pathExists(C.join(e,t)))return i;return null}var U=(e,t)=>e?.dependencies?.[t]||e?.devDependencies?.[t]||"";async function ee(e,t){let i=[];for(let r of t)await P.pathExists(C.join(e,r))&&i.push(r);return i}import d from"fs-extra";import u from"path";import F from"fs-extra";import te from"path";async function G(e,t,i){if(!t||t.length===0)return e;o.debug(`Merging guidelines: ${t.join(", ")}`);let r=[];for(let a of t){let m=te.join(i,`guidelines/${a}.md`);if(await F.pathExists(m)){let E=await F.readFile(m,"utf-8");r.push(E)}}if(r.length===0)return e;let n=r.join(`

---

`);return e.replace(/{{SLOT:guidelines}}[\s\S]*?{{\/SLOT:guidelines}}/,`{{SLOT:guidelines}}

${n}

{{/SLOT:guidelines}}`)}import{fileURLToPath as oe}from"url";var ie=oe(import.meta.url),j=u.dirname(ie);async function N(e,t){o.debug("Starting installation process");let i=u.join(j,"templates");if(d.existsSync(i)||(i=u.join(j,"../templates")),d.existsSync(i)||(i=u.join(process.cwd(),"src/templates")),!d.existsSync(i))throw o.error(`Templates directory not found in: ${i}`),new Error(`Templates directory not found. Searched in: ${u.join(j,"templates")} and ${u.join(j,"../templates")}`);o.debug(`Using templates from: ${i}`),await re(i,e.dryRun),o.debug("Generating prompt files..."),await Promise.all(e.ais.map(r=>ne(r,e,i))),o.debug("Making scripts executable..."),await ae(e.dryRun),e.dryRun?o.success("Dry run completed successfully"):o.success("Installation completed successfully")}async function re(e,t){o.debug("Creating project structure...");let i=u.join(e,"base/.project"),r=".project";if(t)o.info(`[DRY RUN] Would copy ${i} to ${r}`);else try{await d.copy(i,r,{overwrite:!1,errorOnExist:!1})}catch(s){let a=s;throw a.code==="EACCES"?new Error(`Permission denied: Cannot write to ${r}`):a.code==="ENOSPC"?new Error("Disk full: Not enough space to install"):s}let n=u.join(process.cwd(),p.PROJECT_DIR);if(t){o.info(`[DRY RUN] Would ensure directory: ${n}`);for(let s of S)o.info(`[DRY RUN] Would ensure directory: ${u.join(n,s)}`)}else await d.ensureDir(n),await Promise.all(S.map(s=>d.ensureDir(u.join(n,s))))}async function ne(e,t,i){let r=u.join(i,"base/project-manager.md"),n=await d.readFile(r,"utf-8");t.guidelines&&t.guidelines.length>0&&(n=await G(n,t.guidelines,i));let s=se(e);t.dryRun?o.info(`[DRY RUN] Would write prompt file: ${s} (${n.length} bytes)`):await d.writeFile(s,n,"utf-8")}function se(e){return{"claude-code":"CLAUDE.md","claude-ai":"CLAUDE.md",gemini:"GEMINI.md",chatgpt:"CHATGPT.md"}[e]||`${e.toUpperCase()}.md`}async function ae(e){let t=[".project/scripts/pre-session.sh",".project/scripts/validate-dod.sh"];await Promise.all(t.map(async i=>{await d.pathExists(i)&&(e?o.info(`[DRY RUN] Would chmod 755 ${i}`):await d.chmod(i,"755"))}))}import b from"inquirer";import I from"chalk";async function A(e,t={}){o.info(I.blue(`
Installation Options
`));let{ais:i}=await b.prompt([{type:"checkbox",name:"ais",message:"Which AI tools will you use?",choices:[{name:"Claude Code (terminal AI assistant)",value:g.CLAUDE_CODE,checked:!0},{name:"Claude.ai (web interface)",value:g.CLAUDE_AI,checked:!0},{name:"Google Gemini",value:g.GEMINI,checked:!1},{name:"ChatGPT",value:g.CHATGPT,checked:!1}],validate:a=>a.length<1?"You must choose at least one AI tool.":!0}]),r=[{name:"React",value:"react",checked:e.framework?.includes("react")},{name:"Astro",value:"astro",checked:e.framework==="astro"},{name:"Next.js",value:"nextjs",checked:e.framework==="nextjs"},{name:"Vue",value:"vue",checked:e.framework==="vue"}],{guidelines:n}=await b.prompt([{type:"checkbox",name:"guidelines",message:"Add framework-specific guidelines?",choices:r}]),{version:s}=await b.prompt([{type:"list",name:"version",message:"Choose system version:",choices:[{name:"Compact (1,000 tokens, optimized) [RECOMMENDED]",value:"compact",short:"Compact"},{name:"Full (4,000 tokens, comprehensive)",value:"full",short:"Full"}],default:"compact"}]);if(!t.yes){o.info(I.blue(`
Installation Summary
`)),t.dryRun&&o.warn(`  DRY RUN MODE: No files will be created
`),o.info("Files to be created:"),o.info(I.gray("  \u2022 .project/ (directory structure)"));let a=s==="compact"?"~1,000":"~4,000";i.forEach(O=>{let B=ce(O);o.info(I.gray(`  \u2022 ${B} (${a} tokens${n.length>0?" + guidelines":""})`))});let m=e.existingSetup.hasPrompts;m.length>0&&(o.warn(`
 Warning: This will replace existing files:`),m.forEach(O=>o.warn(`   \u2022 ${O}`)));let{confirm:E}=await b.prompt([{type:"confirm",name:"confirm",message:"Proceed with installation?",default:!0}]);if(!E)return null}return{ais:i,guidelines:n,version:s,skipConfirmation:t.yes||!1,dryRun:t.dryRun}}function ce(e){return{[g.CLAUDE_CODE]:f.CLAUDE,[g.CLAUDE_AI]:f.CLAUDE,[g.GEMINI]:f.GEMINI,[g.CHATGPT]:f.CHATGPT}[e]||`${e.toUpperCase()}.md`}async function R(e={}){let t=le("Detecting project...").start(),i=await L();t.succeed("Project detected"),i.framework&&o.info(`Found: ${i.framework} project`),i.hasGit&&o.info("Git repository: Yes"),i.packageManager&&o.info(`Package manager: ${i.packageManager}`);let r;if(e.preset?(o.warn("Preset feature coming soon, using interactive mode"),r=await A(i,e)):e.ai?r={ais:Array.isArray(e.ai)?e.ai:[e.ai],guidelines:e.guidelines?Array.isArray(e.guidelines)?e.guidelines:[e.guidelines]:[],version:e.full?"full":"compact",skipConfirmation:e.yes||!1,dryRun:e.dryRun||!1}:r=await A(i,e),!r){o.error("Installation cancelled");return}t.start("Installing..."),await N(r,i),t.succeed("Installation complete!"),o.success("Installation complete!"),o.info("Next steps:"),o.info(`  1. Run: ${V.cyan(".project/scripts/pre-session.sh")}`),o.info(`  2. Create first task: ${V.cyan("cp .project/_templates/v1/task-template.md .project/current-task.md")}`),o.info("  3. Start coding with AI!"),(r.ais.includes("claude-code")||r.ais.includes("claude-ai"))&&(o.info("Start your AI session with:"),o.info(' "Follow session start protocol and continue development"'))}async function J(e={}){o.info("Updating AIPM..."),await R({...e,yes:e.yes||e.force}),o.success("Update completed")}async function W(){await Promise.resolve(),o.info("Running diff..."),o.warn("Diff functionality is experimental/stubbed.")}import Y from"fs-extra";import H from"path";async function K(){o.info("Validating AIPM installation...");let e=[];await Y.pathExists(H.join(process.cwd(),p.PROJECT_DIR))||e.push(`Missing ${p.PROJECT_DIR} directory`),await Y.pathExists(H.join(process.cwd(),p.PRE_SESSION_SCRIPT))||e.push("Missing pre-session script"),e.length>0&&(o.error("Validation failed:"),e.forEach(t=>o.error(`- ${t}`)),process.exit(1)),o.success("Validation passed")}var T={name:"@rmarsigli/aipm",publishConfig:{access:"public"},type:"module",version:"1.0.1-beta.1",description:"Markdown-based project management system optimized for AI-assisted development",homepage:"https://github.com/rmarsigli/aipm",bugs:{url:"https://github.com/rmarsigli/aipm/issues"},repository:{type:"git",url:"git+https://github.com/rmarsigli/aipm.git"},license:"MIT",author:"Rafhael Marsigli <oi@rafhael.com.br>",main:"dist/cli.js",bin:{aipm:"./dist/cli.js"},scripts:{dev:"tsup --watch",build:"tsup","type-check":"tsc --noEmit",test:"NODE_OPTIONS=--experimental-vm-modules jest",lint:"eslint src/**/*.ts","lint:fix":"eslint src/**/*.ts --fix",format:'prettier --write "src/**/*.ts"',prepare:"husky"},"lint-staged":{"src/**/*.ts":["eslint --fix","prettier --write"]},dependencies:{chalk:"^5.6.2",commander:"^14.0.2",diff:"^8.0.2","fs-extra":"^11.3.3",inquirer:"^13.1.0",ora:"^9.0.0"},devDependencies:{"@eslint/js":"^9.39.2","@jest/globals":"^30.2.0","@types/fs-extra":"^11.0.4","@types/inquirer":"^9.0.9","@types/jest":"^30.0.0","@types/node":"^25.0.3","@typescript-eslint/eslint-plugin":"^8.52.0","@typescript-eslint/parser":"^8.52.0",eslint:"^9.39.2","eslint-config-prettier":"^10.1.8","eslint-plugin-prettier":"^5.5.4",globals:"^17.0.0",husky:"^9.1.7",jest:"^30.2.0","lint-staged":"^16.2.7",prettier:"^3.7.4","ts-jest":"^29.4.6",tsup:"^8.5.1",typescript:"^5.9.3","typescript-eslint":"^8.52.0"},pnpm:{overrides:{"test-exclude":"^7.0.1"}}};var x=T.version,wt=T.name;function z(e){let t=pe(e);console.log(t)}function pe(e){let t=e.commands.map(r=>r.name()),i=t.map(r=>{let s=e.commands.find(a=>a.name()===r)?.options.map(a=>{let m=a.flags.split(",");return(m.length>1?m[1]:m[0]).trim().split(" ")[0]})||[];return{name:r,opts:s}});return`
# aipm bash completion

_aipm_completion() {
    local cur prev
    cur="\${COMP_WORDS[COMP_CWORD]}"
    prev="\${COMP_WORDS[COMP_CWORD-1]}"
    
    # Global commands
    local commands="${t.join(" ")}"
    
    # Options per command
    ${i.map(r=>`
    if [[ "\${COMP_WORDS[1]}" == "${r.name}" ]]; then
        COMPREPLY=( $(compgen -W "${r.opts.join(" ")}" -- "$cur") )
        return 0
    fi
    `).join("")}

    # Main command completion
    if [[ "$prev" == "aipm" ]]; then
        COMPREPLY=( $(compgen -W "$commands" -- "$cur") )
        return 0
    fi
}

complete -F _aipm_completion aipm
`}var h=new ue,q=`
 \u2588\u2588\u2588\u2588\u2588\u2557 \u2588\u2588\u2557\u2588\u2588\u2588\u2588\u2588\u2588\u2557 \u2588\u2588\u2588\u2557   \u2588\u2588\u2588\u2557
\u2588\u2588\u2554\u2550\u2550\u2588\u2588\u2557\u2588\u2588\u2551\u2588\u2588\u2554\u2550\u2550\u2588\u2588\u2557\u2588\u2588\u2588\u2588\u2557 \u2588\u2588\u2588\u2588\u2551
\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2551\u2588\u2588\u2551\u2588\u2588\u2588\u2588\u2588\u2588\u2554\u255D\u2588\u2588\u2554\u2588\u2588\u2588\u2588\u2554\u2588\u2588\u2551
\u2588\u2588\u2554\u2550\u2550\u2588\u2588\u2551\u2588\u2588\u2551\u2588\u2588\u2554\u2550\u2550\u2550\u255D \u2588\u2588\u2551\u255A\u2588\u2588\u2554\u255D\u2588\u2588\u2551
\u2588\u2588\u2551  \u2588\u2588\u2551\u2588\u2588\u2551\u2588\u2588\u2551     \u2588\u2588\u2551 \u255A\u2550\u255D \u2588\u2588\u2551
\u255A\u2550\u255D  \u255A\u2550\u255D\u255A\u2550\u255D\u255A\u2550\u255D     \u255A\u2550\u255D     \u255A\u2550\u255D
`;h.name("aipm").description("AI-optimized project management system").version(x).option("-v, --verbose","Enable verbose logging").hook("preAction",e=>{e.opts().verbose&&(o.setVerbose(!0),o.debug("Verbose mode enabled"))});h.command("install").description("Install AIPM in current directory").option("-y, --yes","Skip confirmation prompts").option("-p, --preset <name>","Use preset configuration").option("--ai <ais...>","AI tools to use (claude-code, gemini, chatgpt)").option("--guidelines <frameworks...>","Framework guidelines (react, astro)").option("--compact","Use compact version (default)",!0).option("--full","Use full version").option("--dry-run","Simulate actions without writing files").action(async e=>{console.log(y.blue(q)),console.log(y.blue(`AIPM v${x}
`));try{await R(e)}catch(t){let i=t instanceof Error?t.message:String(t);console.error(y.red(`
Error: ${i}
`)),process.exit(1)}});h.command("update").description("Update existing installation").option("-f, --force","Overwrite customizations").option("--ai <ais...>","AI tools to use (claude-code, gemini, chatgpt)").option("--guidelines <frameworks...>","Framework guidelines (react, astro)").option("--compact","Use compact version (default)",!0).option("--full","Use full version").option("--dry-run","Simulate actions without writing files").action(async e=>{console.log(y.blue(q)),console.log(y.blue(`AIPM v${x}
`));try{await J(e)}catch(t){let i=t instanceof Error?t.message:String(t);console.error(y.red(`
Error: ${i}
`)),process.exit(1)}});h.command("diff").description("Show what would change with update").action(async()=>{try{await W()}catch(e){let t=e instanceof Error?e.message:String(e);console.error(y.red(`
Error: ${t}
`)),process.exit(1)}});h.command("validate").description("Validate current installation").action(async()=>{try{await K()}catch(e){let t=e instanceof Error?e.message:String(e);console.error(y.red(`
Error: ${t}
`)),process.exit(1)}});h.command("completion").description("Generate shell completion script").action(()=>{z(h)});h.parse(process.argv);process.argv.slice(2).length||h.outputHelp();
